---
import '@/styles/global.css';

import CookieBanner from '@components/svelte/CookieBanner.svelte';
import GoToTop from '@components/svelte/GoToTop.svelte';
import RhythmDebug from '@components/svelte/RhythmDebug.svelte';
import { FEATURES } from '@config/features';
import type { Locale } from '@type/locale';
import type { ISEOMetadata } from '@type/seo';
import { loadLocaleContent, type LocaleContent } from '@utils/content-loader';

import Footer from './Footer.astro';
import Head from './Head.astro';
import Menu from './Menu.astro';
import SkipLink from './SkipLink.astro';

export interface Props extends ISEOMetadata {
    locale: Locale;
    translationPath?: string;
    pageMap?: LocaleContent['pageMap'] | undefined;
}

const { locale, translationPath, pageMap: providedPageMap, ...seoProps } = Astro.props as Props;
const currentPath = Astro.url.pathname;

// Use provided pageMap if available, otherwise load content (fallback for error pages)
const pageMap = providedPageMap ?? (await loadLocaleContent(locale)).pageMap;
---

<!doctype html>
<html lang={locale}>
    <head>
        <script is:inline nonce={Astro.locals.nonce}>
            function applyTheme() {
                const theme = localStorage.getItem('theme');
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const isDark = theme === 'dark' || (!theme && systemPrefersDark);

                if (isDark) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }

            applyTheme();

            document.addEventListener('astro:after-swap', applyTheme);
        </script>

        <Head {...seoProps} locale={locale} {...translationPath ? { translationPath } : {}} />
    </head>

    <body
        class:list={[import.meta.env.DEV && 'debug-screens', 'flex min-h-screen flex-col bg-page-bg text-text-primary']}
    >
        <SkipLink locale={locale} />
        <Menu locale={locale} currentPath={currentPath} translationPath={translationPath} pageMap={pageMap} />

        <main id="main-content" class="bg-dots flex-1">
            <slot />
        </main>

        <Footer locale={locale} />

        {FEATURES.goToTop && <GoToTop client:visible locale={locale} />}

        {FEATURES.cookieBanner && <CookieBanner client:idle locale={locale} />}

        {import.meta.env.DEV && <RhythmDebug client:idle />}
    </body>
</html>
