---
import '@/styles/mdx-content.css';

import Button from '@components/svelte/Button.svelte';
import NewsletterForm from '@components/svelte/NewsletterForm.svelte';
import { FEATURES } from '@config/features';
import { getRoute } from '@config/routes';
import { SITE } from '@config/site';
import { getTranslation } from '@i18n/translations';
import { calculateReadingTime, calculateWordCount } from '@i18n/utils';
import type { Locale } from '@type/locale';
import type { ISEOMetadata } from '@type/seo';
import type { LocaleContent } from '@utils/content-loader';
import { formatDate } from '@utils/formatDate';

import HeadingLinks from './HeadingLinks.astro';
import PageLayout from './PageLayout.astro';

export interface Props extends ISEOMetadata {
    locale: Locale;
    title: string;
    displayTitle?: string;
    pubDate: Date;
    updatedDate?: Date;
    tags?: string[];
    content: string;
    translationPath?: string;
    pageMap?: LocaleContent['pageMap'] | undefined;
}

const {
    locale,
    title,
    displayTitle: providedDisplayTitle,
    description,
    permalink,
    pubDate,
    updatedDate,
    tags = [],
    content,
    translationPath,
    pageMap,
    ...seoProps
} = Astro.props as Props;

const t = getTranslation(locale);
const readingTime = calculateReadingTime(content);
const displayTitle = providedDisplayTitle || title.replace(/ ï¿­ Ambilab$/, '');
const newsUrl = `${getRoute('news', locale)}`;

const nonce = Astro.locals.nonce;
const siteDomain = Astro.url.origin;
const wordCount = calculateWordCount(content);
const rawImage = seoProps.ogImage || SITE.DEFAULT_OG_IMAGE;
const imageUrl =
    rawImage.startsWith('http://') || rawImage.startsWith('https://') || rawImage.startsWith('//')
        ? rawImage
        : `${siteDomain}${rawImage.startsWith('/') ? rawImage : `/${rawImage}`}`;

const jsonLd = {
    '@context': 'https://schema.org',
    '@type': 'BlogPosting',
    headline: displayTitle,
    description: description,
    author: {
        '@type': 'Organization',
        name: SITE.AUTHOR,
        url: SITE.URL,
    },
    datePublished: pubDate.toISOString(),
    dateModified: (updatedDate || pubDate).toISOString(),
    image: imageUrl,
    url: permalink,
    publisher: {
        '@type': 'Organization',
        name: SITE.NAME,
        logo: {
            '@type': 'ImageObject',
            url: `${siteDomain}/logo.png`,
            width: 600,
            height: 60,
        },
    },
    mainEntityOfPage: {
        '@type': 'WebPage',
        '@id': permalink,
    },
    wordCount,
    ...(tags.length > 0 ? { keywords: tags.join(', ') } : {}),
};

// Escape HTML-significant chars in the serialized JSON so a value like
// "</script>" cannot close the enclosing <script> tag.
// '\\u003C' is the 6-char literal \u003C in the output; a JSON parser
// re-interprets it as '<', but the HTML parser never sees a raw '<'.
const jsonLdScript = JSON.stringify(jsonLd).replace(/&/g, '\\u0026').replace(/</g, '\\u003C').replace(/>/g, '\\u003E');

const articleMetadata = {
    articlePublishedTime: pubDate,
    ...(updatedDate ? { articleModifiedTime: updatedDate } : {}),
    articleAuthor: SITE.AUTHOR,
    articleSection: t.news.title,
    articleTags: tags,
};
---

<PageLayout
    locale={locale}
    title={title}
    description={description}
    permalink={permalink}
    pageMap={pageMap}
    {...translationPath ? { translationPath } : {}}
    {...seoProps}
    {...articleMetadata}
>
    <article class="container mx-auto px-4">
        {
            FEATURES.structuredData && (
                <script is:inline type="application/ld+json" nonce={nonce} set:html={jsonLdScript} />
            )
        }

        <header class="mx-auto mb-8 mt-[18px] max-w-[764px] pt-3 sm:mt-[21px] md:mb-[43px] md:mt-7 lg:max-w-[896px]">
            <Button href={newsUrl} variant="secondary" size="sm">&larr; {t.news.title}</Button>

            <h1
                class="md:leading-18 -ml-[1.5px] mb-[6px] block w-full pt-2 text-[36px] leading-9 sm:text-[40px] sm:leading-10 md:-ml-1 md:mb-[9px] md:pt-[11px] md:text-[73px] md:font-light md:tracking-tight"
            >
                {displayTitle}
            </h1>

            <div class="meta -ml-px">
                <div class="flex flex-wrap items-center gap-4">
                    <div class="flex items-center gap-2">
                        <time datetime={pubDate.toISOString()}>
                            {t.news.publishedOn}
                            {formatDate(pubDate, locale)}
                        </time>
                    </div>

                    {
                        updatedDate && (
                            <div class="flex items-center gap-2">
                                <time datetime={updatedDate.toISOString()}>
                                    {t.news.updatedOn} {formatDate(updatedDate, locale)}
                                </time>
                            </div>
                        )
                    }
                </div>
                <div>
                    {t.news.readingTime}:
                    {readingTime}
                    {t.news.minutesShort}
                </div>

                {
                    tags.length > 0 && (
                        <div class="flex flex-wrap items-center gap-2">
                            {tags.map((tag) => (
                                <span>#{tag}</span>
                            ))}
                        </div>
                    )
                }
            </div>
        </header>

        <div class="mdx-content 2xl:px-76 prose prose-lg mx-auto mb-12 dark:prose-invert md:mb-16 lg:px-12 xl:px-44">
            <slot />

            <div class="select-none font-mono text-[22px] uppercase leading-3 antialiased" aria-hidden="true">
                &spades;
            </div>
        </div>

        {
            FEATURES.newsletter && (
                <div class="mx-auto max-w-4xl pb-8 sm:pb-10 md:pb-12">
                    <NewsletterForm client:idle locale={locale} />
                </div>
            )
        }
    </article>

    <HeadingLinks />
</PageLayout>
