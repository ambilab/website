---
description: Agent workflow and automation guidance
globs: ['**/*']
alwaysApply: true
---

# Agent Workflow and Automation

Practical guidance for AI agents working on the Ambilab website.

## Automatic Quality Checks

A **stop hook** runs automatically after you complete tasks:

1. Runs `pnpm format` to auto-format all code
2. Runs `pnpm typecheck` to catch type errors
3. If issues are found, you receive a follow-up message to fix them
4. Maximum 3 iterations to prevent infinite loops
5. When checks pass, the conversation ends cleanly

**What this means:**

- Focus on implementing features correctly
- Don't manually run `pnpm format` after every change (the hook does it)
- Pay attention to type safety while coding
- Fix issues promptly when the hook reports them

## Available Skills

### /quick-format

Fastest formatting without verification:

```cursor
/quick-format
```

Runs formatters only. Use for quick cleanup when you just need to fix formatting.

### /format

Quick format and verification:

```cursor
/format
```

Formats all code, shows what changed, and verifies formatting passes. Use during development for quick checks.

### /preflight

Comprehensive pre-commit checks:

```cursor
/preflight
```

Runs ALL quality checks: format, lint, typecheck, tests, spellcheck, knip. Use before creating commits or PRs.

### /pr

Create a pull request with automatic workflow:

```cursor
/pr Add newsletter feature
```

Runs preflight, creates conventional commit, pushes, and creates PR with `gh` CLI.

### /review

Review current changes against project rules:

```cursor
/review
```

Checks code against all project conventions and quality standards. Fast feedback during development.

### /deep-review

Comprehensive pre-push review (replaces CodeRabbit):

```cursor
/deep-review
```

Runs full preflight, security audit, comprehensive manual code review, and generates a PR-ready summary. Use before
pushing to remote.

## Local Code Review Workflow

This project uses local code review instead of cloud-based tools like CodeRabbit. All reviews happen before pushing,
using Cursor skills and git hooks.

### Recommended Pre-Push Flow

1. **During development**: Use `/review` for quick feedback on conventions
2. **Before pushing**: Run `/deep-review` for comprehensive analysis
3. **Push**: The pre-push hook validates everything automatically
4. **Create PR**: Copy the summary from `/deep-review` to your PR description

### What Replaced CodeRabbit

| CodeRabbit Feature | Local Replacement                         |
| ------------------ | ----------------------------------------- |
| Auto PR review     | `/review` or `/deep-review` before push   |
| Security scanning  | `pnpm audit` + `eslint-plugin-security`   |
| Code quality       | Biome + ESLint + TypeScript strict        |
| Best practices     | Project rules + comprehensive AI analysis |
| Change summary     | `/deep-review` generates PR summary       |

### Benefits of Local Review

- No rate limits or waiting for cloud services
- Faster feedback loop (review before push, not after)
- Works offline
- No additional cost (uses existing Cursor/Claude subscription)
- Ready for Codeberg migration (no GitHub Actions dependency)

## Common Workflows

### Making Component Changes

1. Edit component file(s)
2. Update types if needed
3. Update or add E2E tests in `tests/e2e/` if the change affects user-facing behavior
4. Stop hook auto-formats and type-checks
5. Fix any reported issues
6. Use `/pr` to create a pull request

### Adding News Posts

1. Create MDX files: `src/content/news/en/slug.mdx` and `src/content/news/cs/slug.mdx`
2. Add required frontmatter (title, description, locale, pubDate, translationSlug)
3. Link translations via `translationSlug` field
4. Write content
5. Stop hook handles formatting
6. Use `/pr` to create a pull request

### Fixing Type Errors

When the stop hook reports type errors:

1. Read the error message (file and line number)
2. Common fixes:
   - Add missing type imports: `import type { TypeName } from '@type/path'`
   - Replace `any` with proper types or `unknown`
   - Add optional chaining: `object?.property`
   - Ensure frontmatter fields are complete
3. The hook will verify your fix

## Quality Commands Reference

| Command               | Purpose                            | When to Use               |
| --------------------- | ---------------------------------- | ------------------------- |
| `pnpm format`         | Format code (Biome + Prettier)     | Auto-run by hook          |
| `pnpm typecheck`      | TypeScript + Astro type checking   | Auto-run by hook          |
| `pnpm lint`           | Linting (Biome + ESLint)           | Before committing         |
| `pnpm lint:fix`       | Auto-fix lint issues               | To fix lint errors        |
| `pnpm spellcheck`     | Check spelling                     | Before committing         |
| `pnpm preflight`      | ALL checks (comprehensive)         | Before pushing            |
| `pnpm review:full`    | Preflight + build + security audit | Manual pre-push check     |
| `pnpm security:audit` | Check dependency vulnerabilities   | Security review           |
| `pnpm test:run`       | Run unit tests (Vitest)            | After logic changes       |
| `pnpm test:e2e`       | Run E2E tests (Playwright)         | After UI/behavior changes |
| `pnpm dev`            | Start dev server                   | During development        |
| `pnpm build`          | Build for production               | Test production builds    |

## Pre-Push Hook

The pre-push hook runs automatically when you `git push` and validates:

1. Format check (`pnpm format:check`)
2. Lint check (`pnpm lint`)
3. Spell check (`pnpm spellcheck`)
4. Type check (`pnpm typecheck`)
5. Unused exports (`pnpm knip`)
6. Production build (`pnpm build`)
7. Security audit (`pnpm audit --audit-level=high`)

If any check fails, the push is blocked. Fix the issues and try again.

To run these checks manually before pushing: `pnpm review:full`

## Pre-Completion Checklist

Before considering a task complete:

- [ ] Code passes type checking (verified by stop hook)
- [ ] Code is properly formatted (done by stop hook)
- [ ] No emoji used anywhere (RULE #1)
- [ ] Translations added for both en/cs (if applicable)
- [ ] Semantic design tokens used for colors (not `gray-900`, use `text-text-muted`)
- [ ] Svelte components have `client:*` directives when imported in Astro
- [ ] Images have alt text
- [ ] Animations respect `prefers-reduced-motion`
- [ ] Existing tests still pass (`pnpm test:run` for unit, `pnpm test:e2e` for E2E)
- [ ] New/changed user-facing behavior has E2E test coverage (see Testing section)

## Working with the Stop Hook

### Normal Flow

1. You make changes to implement a feature
2. You signal completion
3. Stop hook runs automatically (format + typecheck)
4. If checks pass: Done
5. If checks fail: You receive follow-up with issues
6. You fix the issues
7. Repeat until checks pass (max 3 iterations)

### Hook Limitations

The stop hook only runs:

- `pnpm format` (formatting)
- `pnpm typecheck` (type checking)

It does NOT run linting, spellcheck, or knip. For comprehensive checks, use `/preflight` skill.

## Testing

### Test Infrastructure

- **Unit tests**: Vitest + Testing Library, located in `src/` alongside source files
- **E2E tests**: Playwright, located in `tests/e2e/`
- **E2E preview server**: `pnpm preview` (wrangler pages dev) on port 4321
- **E2E requires a build first**: Run `pnpm build` before `pnpm test:e2e`

### When to Write Tests

- **New interactive component**: Add E2E test in `tests/e2e/` covering key user interactions
- **Changed component behavior**: Update existing E2E tests to match new behavior
- **New API route**: Add E2E tests for success, validation, and error responses
- **Bug fix**: Add a test that would have caught the bug

### E2E Test Conventions

- **Feature-flag gating**: Components behind feature flags must use runtime detection with `test.skip()`:

```typescript
import type { Page } from '@playwright/test';

async function isFeatureEnabled(page: Page): Promise<boolean> {
  await page.goto('/');
  return (await page.locator('[data-testid="my-feature"]').count()) > 0;
}

test('should do something', async ({ page }) => {
  const enabled = await isFeatureEnabled(page);
  test.skip(!enabled, 'Feature flag is disabled');
  // ... test body
});
```

- **Type imports**: Use `import type { Page } from '@playwright/test'` (not inline `import()` annotations)
- **Test isolation**: Each test gets a fresh browser context (localStorage, cookies are not shared)
- **Server-side state**: Rate limiters and in-memory caches persist across tests in the same run
- **Hydration awareness**: Components using `client:idle` or `client:visible` may need explicit waits before interaction
- **File naming**: `tests/e2e/<feature-name>.spec.ts`

### Running Tests

```bash
pnpm test:run         # Unit tests (Vitest, single run)
pnpm test:e2e         # E2E tests (Playwright, requires prior build)
pnpm test             # Unit tests (Vitest, watch mode)
```

## Best Practices

1. **Trust the automation** - Let the stop hook handle formatting
2. **Write type-safe code** - Avoid `any`, use proper types
3. **Never use emoji** - This is RULE #1 with zero exceptions
4. **Use semantic tokens** - For colors, use `text-text-primary` not `text-blue-600`
5. **Test locally** - Run `pnpm dev` to verify changes work
6. **Follow conventions** - Use path aliases, type imports, conventional commits
7. **Document changes** - Add JSDoc comments for exported functions
8. **Consider accessibility** - Alt text, reduced motion, semantic HTML

## Troubleshooting

### Hook keeps failing

- Review error messages carefully
- Fix one issue at a time
- Use `/format` skill to test fixes
- If stuck after 3 iterations, report to user

### Type errors persist

- Check imports use `import type` for types
- Verify Content Collection schemas match frontmatter
- Look for missing null checks or optional chaining
- Ensure strict TypeScript settings are followed

## Configuration

- Stop hook source: `cursor-config/hooks.json` and `cursor-config/hooks/on-stop.sh` (auto-synced to `.cursor/`)
- Skills source: `cursor-config/skills/*/SKILL.md` (auto-synced to `.cursor/`)
- Sync command: `pnpm sync-rules` (copies `cursor-config/` to `.cursor/`)
